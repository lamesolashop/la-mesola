<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop - La Mesola</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- CSS (invariato) -->
    <style>:root{--primary-color:#004d40;--text-color:#333;--card-bg:#ffffff}html,body{margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background-color:#f7f9f9;color:var(--text-color)}.site-wrapper{display:flex;position:relative;overflow-x:hidden}.content-wrapper{flex-grow:1;transition:margin-right .3s ease}.cart-sidebar{width:350px;position:fixed;top:0;right:-370px;height:100%;background-color:#fff;box-shadow:-4px 0 15px rgba(0,0,0,.1);z-index:1001;transition:right .3s ease;display:flex;flex-direction:column}.cart-sidebar.open{right:0}@media(min-width:901px){.content-wrapper.cart-open{margin-right:350px}}header{background-color:#fff;padding:10px 25px;box-shadow:0 2px 4px rgba(0,0,0,.05);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:999}header .logo a{font-weight:700;color:var(--primary-color);text-decoration:none;font-size:1.5rem}.header-actions{display:flex;align-items:center;gap:25px}.header-cart-icon{font-size:1.5rem;cursor:pointer;color:#555;position:relative}.cart-badge{position:absolute;top:-5px;right:-10px;background:#d32f2f;color:#fff;border-radius:50%;width:20px;height:20px;font-size:.8rem;display:flex;align-items:center;justify-content:center;font-weight:700}#hero-section{height:50vh;background-size:cover;background-position:center;position:relative;display:flex;align-items:center;justify-content:center;text-align:center;color:#fff;text-shadow:2px 2px 4px rgba(0,0,0,.7)}#hero-section::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,.5);z-index:1}.hero-content{position:relative;z-index:2;padding:20px}.page-container{max-width:1200px;margin:0 auto;padding:25px}#product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:30px}.product-card{background-color:var(--card-bg);border-radius:12px;overflow:hidden;cursor:pointer;transition:transform .3s,box-shadow .3s;display:flex;flex-direction:column;box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}.product-card:hover{transform:translateY(-8px) scale(1.02);box-shadow:0 20px 25px -5px rgba(0,0,0,.1)}.product-card img{width:100%;height:auto;aspect-ratio:2/3;object-fit:cover;display:block;background-color:#f0f0f0}.card-content{padding:20px;flex-grow:1;display:flex;flex-direction:column;justify-content:space-between}.product-title{font-size:1.2rem;margin:0 0 10px;color:var(--primary-color)}.card-info{font-size:.9rem;color:#666;margin-bottom:15px;border-left:3px solid #eee;padding-left:10px}.price-container{font-size:1.2rem;font-weight:700;margin-top:10px}footer{text-align:center;padding:40px 20px;background-color:var(--card-bg);margin-top:40px}.loading,.error{text-align:center;padding:50px;font-size:1.2rem;color:#666}.error{color:#d32f2f}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000}.modal-content{background:#fff;padding:30px;border-radius:10px;width:90%;max-width:900px;max-height:90vh;overflow-y:auto;position:relative}.modal-close{position:absolute;top:10px;right:20px;font-size:2.5rem;color:#aaa;cursor:pointer;line-height:1}.modal-body{display:grid;grid-template-columns:1fr 1fr;gap:30px}@media (max-width:768px){.modal-body{grid-template-columns:1fr}}.modal-gallery #modal-main-image{width:100%;height:auto;max-height:450px;object-fit:contain;border-radius:8px;border:1px solid #eee;margin-bottom:15px}.thumbnail-strip{display:flex;gap:10px;justify-content:center}.thumbnail-strip .thumbnail{width:70px;height:70px;object-fit:cover;border-radius:8px;cursor:pointer;border:2px solid #ddd;opacity:.7;transition:opacity .2s,border-color .2s}.thumbnail-strip .thumbnail:hover,.thumbnail-strip .thumbnail.active{opacity:1;border-color:var(--primary-color)}.action-button{display:flex;align-items:center;justify-content:center;width:100%;box-sizing:border-box;padding:12px;border-radius:5px;text-decoration:none;font-weight:700;margin-top:15px;cursor:pointer;border:none;font-size:1em;line-height:1.5}.quantity-selector{display:flex;align-items:center;gap:10px;margin-top:20px;margin-bottom:10px}.quantity-selector input{width:50px;text-align:center;font-size:1.1rem;border:1px solid #ccc;border-radius:5px}.cart-header{padding:20px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}.cart-items{flex-grow:1;overflow-y:auto;padding:10px 20px}.cart-item{display:flex;align-items:center;margin-bottom:15px}.cart-item img{width:60px;height:60px;object-fit:cover;border-radius:5px;margin-right:15px}.cart-item-details{flex-grow:1}.cart-item-details h4{margin:0 0 5px;font-size:1rem}.cart-item-details p{margin:0;color:#777}.cart-item-remove{font-size:1.2rem;color:#aaa;cursor:pointer}.cart-footer{padding:20px;border-top:1px solid #eee}.cart-total{display:flex;justify-content:space-between;font-weight:700;font-size:1.2rem;margin-bottom:15px}.coupon-section{display:flex;gap:10px;margin-bottom:15px}.coupon-section input{flex-grow:1;border:1px solid #ccc;padding:8px;border-radius:5px}.coupon-section button{padding:8px 12px;border:none;background:var(--primary-color);color:#fff;border-radius:5px;cursor:pointer}
    </style>
</head>
<body>
    <!-- HTML del body (invariato) -->
    <div class="site-wrapper">...</div>
    
    <!-- Script di caricamento API Google -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script>
        // --- CONFIGURAZIONE ---
        const SCRIPT_ID = 'AKfycbwFrnYFsz8_Ge6ehhBpSS4r4OvNwFcGbemNIhYAt6ARJCJnWEzkRn3tfx2-_GQvywRn'; // Es. AKfy...
        const API_KEY = 'AIzaSyD4pqfKCD5xt4Gs299KfCtp7t6Q3DbiB5U';
        // --- FINE CONFIGURAZIONE ---

        const driveImageUrl = "https://lh3.googleusercontent.com/d/";
        let allProducts = [], currentProduct = null, cart = [];
        let appliedCoupon = null;
        let isGapiReady = false;

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ["https://script.googleapis.com/$discovery/rest?version=v1"],
            });
            isGapiReady = true;
            loadInitialData();
        }

        function callAppsScript(functionName, params) {
            if (!isGapiReady) {
                return Promise.reject(new Error("API Google non ancora pronta."));
            }
            return gapi.client.script.scripts.run({
                scriptId: SCRIPT_ID,
                resource: {
                    function: functionName,
                    parameters: params ? [params] : [],
                    devMode: false 
                }
            }).then(resp => {
                if (resp.result && resp.result.error) {
                    throw new Error(resp.result.error.message || 'Errore sconosciuto dallo script.');
                }
                return resp.result.response.result;
            });
        }
        
        document.addEventListener("DOMContentLoaded", () => {
             // L'inizializzazione ora parte da gapiLoaded
        });

        async function loadInitialData() {
            try {
                const data = await callAppsScript('getInitialData');
                initializeApp(data);
            } catch (err) {
                handleError(err);
            }
        }
        
        function initializeApp(data) {
          if (!data || data.error) { handleError(data || { message: "Dati non ricevuti." }); return; }
          if (new URLSearchParams(window.location.search).get('payment') === 'success') { alert('Grazie! Acquisto completato.'); localStorage.removeItem('laMesolaShopCart'); window.history.replaceState({}, '', window.location.pathname); }
          allProducts = data.products || [];
          renderProducts(allProducts);
          loadCart();
        }

        function handleError(error) { document.getElementById("product-grid").innerHTML = `<div class="error"><h1>ERRORE</h1><p>${error.message}</p></div>`; }
        function renderProducts(products) { const grid = document.getElementById("product-grid"); grid.innerHTML = ''; if (!products.length) { grid.innerHTML = `<div class="error">Nessun prodotto trovato.</div>`; return; } products.forEach((p, i) => { const imgUrl = p.thumbnailId ? `${driveImageUrl}${p.thumbnailId}` : `https://via.placeholder.com/290x435?text=N/A`; const priceHtml = p.discountedPrice ? `<s>${p.price}</s> <span style="color:#d32f2f;">${p.discountedPrice}</span>` : (p.price || "N.D."); const card = document.createElement('div'); card.className = 'product-card'; card.onclick = () => openProductModal(i); card.innerHTML = `<img src="${imgUrl}" alt="${p.name}"><div class="card-content"><div><h2 class="product-title">${p.name}</h2><div class="card-info"><span>${p.cl} L</span> | <span>${p.sentore}</span><br><small><strong>Botaniche:</strong> ${p.botaniche}</small></div></div><div class="price-container">${priceHtml}</div></div>`; grid.appendChild(card); }); }
        
        // ... (tutte le altre funzioni da openModal a loadCart rimangono identiche) ...

        async function handleCheckout() {
            if(cart.length === 0) { alert("Il carrello Ã¨ vuoto!"); return; }
            const btn = document.getElementById('checkout-button');
            btn.disabled = true; btn.textContent = 'Procedo...';
            const dataToSend = { cart: cart, coupon: appliedCoupon ? appliedCoupon.code : null };

            try {
                const res = await callAppsScript('createCheckoutSession', dataToSend);
                if (res.error) throw new Error(res.error);
                if (res.url) { 
                    localStorage.removeItem('laMesolaShopCart'); 
                    window.location.href = res.url; 
                } else {
                    throw new Error("URL di checkout non ricevuto.");
                }
            } catch(err) {
                alert('Errore: ' + err.message);
                btn.disabled = false; btn.textContent = 'Procedi al Checkout';
            }
        }
    </script>
</body>
</html>
