// File: shop.html
// Sostituisci l'intero tag <script>

    <script>
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxE5klyPe4QfL4ZARqQCmio7AG4nu25yw2MoZSr5OcSnBWpCsXC-JZiP__3_Mqpednz/exec'; // Incolla qui il tuo URL
      const driveImageUrl = "https://lh3.googleusercontent.com/d/";
      let allProducts = [], currentProduct = null, cart = [];
      let appliedCoupon = null;

      // Chiamata GET iniziale con fetch
      document.addEventListener("DOMContentLoaded", async () => {
        const grid = document.getElementById("product-grid");
        try {
            const response = await fetch(SCRIPT_URL);
            if (!response.ok) throw new Error(`Errore di rete: ${response.statusText}`);
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            if (data.siteInfo && data.siteInfo.heroImageId) { document.getElementById("hero-section").style.backgroundImage = `url('${driveImageUrl}${data.siteInfo.heroImageId}')`; }
            allProducts = data.products || [];
            renderProducts(allProducts);
            loadCart();
            if (new URLSearchParams(window.location.search).get('payment') === 'success') {
                alert('Grazie! Il tuo acquisto è andato a buon fine.');
                cart = []; appliedCoupon = null; saveCart(); updateCartUI();
                window.history.replaceState({}, '', window.location.pathname);
            }
        } catch (e) {
            grid.innerHTML = `<div class="error"><h1>ERRORE</h1><p>${e.message}</p></div>`;
        }
      });
      
      // Funzione di checkout che usa google.script.run
      function handleCheckout() {
        if(cart.length === 0) { alert("Il carrello è vuoto!"); return; }
        const btn = document.getElementById('checkout-button');
        btn.disabled = true;
        btn.textContent = 'Procedo...';
        
        const dataToSend = {
            cart: cart,
            coupon: appliedCoupon ? appliedCoupon.code : null
        };

        // Converte l'oggetto in una stringa JSON
        const jsonStringPayload = JSON.stringify(dataToSend);

        google.script.run
            .withSuccessHandler(res => {
                if (res.error) {
                    alert(`Errore: ${res.error}`);
                    btn.disabled = false;
                    btn.textContent = 'Procedi al Checkout';
                } else if (res.url) {
                    localStorage.removeItem('laMesolaShopCart');
                    window.location.href = res.url;
                }
            })
            .withFailureHandler(err => {
                alert('Errore grave: ' + err.message);
                btn.disabled = false;
                btn.textContent = 'Procedi al Checkout';
            })
            .createCheckoutSession(jsonStringPayload); // Invia la stringa
      }

      // Tutte le altre funzioni (renderProducts, openModal, etc.) rimangono invariate.
      // Le incollo qui per essere sicuro che siano corrette.
      function renderProducts(products) { const grid = document.getElementById("product-grid"); grid.innerHTML = ''; if (!products.length) { grid.innerHTML = `<div class="error">Nessun prodotto trovato.</div>`; return; } products.forEach((p, i) => { const imgUrl = p.thumbnailId ? `${driveImageUrl}${p.thumbnailId}` : `https://via.placeholder.com/290x435?text=N/A`; const priceHtml = p.discountedPrice ? `<s>${p.price}</s> <span style="color:#d32f2f;">${p.discountedPrice}</span>` : (p.price || "N.D."); const card = document.createElement('div'); card.className = 'product-card'; card.onclick = () => openProductModal(i); card.innerHTML = `<img src="${imgUrl}" alt="${p.name}"><div class="card-content"><div><h2 class="product-title">${p.name}</h2><div class="card-info"><span>${p.cl} L</span> | <span>${p.sentore}</span><br><small><strong>Botaniche:</strong> ${p.botaniche}</small></div></div><div class="price-container">${priceHtml}</div></div>`; grid.appendChild(card); }); }
      function openModal(id) { document.getElementById(id).style.display = 'flex'; }
      function closeModal() { document.getElementById('product-modal').style.display = 'none'; }
      function openProductModal(index) { currentProduct = allProducts[index]; document.getElementById("modal-title").textContent = currentProduct.name; document.getElementById("modal-description").textContent = currentProduct.description; document.getElementById("modal-price").innerHTML = currentProduct.discountedPrice ? `<s>${currentProduct.price}</s> <span style="color:#d32f2f;">${currentProduct.discountedPrice}</span>` : (currentProduct.price || ''); document.getElementById("modal-quantity").value = 1; const mainImage = document.getElementById("modal-main-image"); const thumbStrip = document.getElementById("thumbnail-strip"); thumbStrip.innerHTML = ''; const imageUrls = [currentProduct.thumbnailId, currentProduct.image1Id, currentProduct.image2Id].filter(Boolean); if (imageUrls.length > 0) { mainImage.src = driveImageUrl + imageUrls[0]; imageUrls.forEach(id => { const thumb = document.createElement('img'); thumb.src = driveImageUrl + id; thumb.className = 'thumbnail'; thumb.onclick = e => { e.stopPropagation(); mainImage.src = driveImageUrl + id; }; thumbStrip.appendChild(thumb); }); } else { mainImage.src = 'https://via.placeholder.com/400x600?text=N/A'; } openModal('product-modal'); }
      function toggleCart() { document.getElementById('cart-sidebar').classList.toggle('open'); document.getElementById('content-wrapper').classList.toggle('cart-open'); }
      function handleAddToCart() { if (!currentProduct) return; const quantity = parseInt(document.getElementById('modal-quantity').value, 10); if (isNaN(quantity) || quantity < 1) return; const existingItem = cart.find(item => item.name === currentProduct.name); if (existingItem) { existingItem.quantity += quantity; } else { cart.push({ ...currentProduct, quantity: quantity }); } saveCart(); updateCartUI(); closeModal(); if(!document.getElementById('cart-sidebar').classList.contains('open')) toggleCart(); }
      function removeFromCart(productName) { cart = cart.filter(item => item.name !== productName); if (appliedCoupon && !cart.find(item => item.name === appliedCoupon.productName)) { appliedCoupon = null; } saveCart(); updateCartUI(); }
      function updateCartUI() { const container = document.getElementById('cart-items'); const subtotalEl = document.getElementById('cart-subtotal'); const totalEl = document.getElementById('cart-total'); const badge = document.getElementById('cart-badge'); const shippingEl = document.getElementById('shipping-cost-text'); container.innerHTML = ''; let subtotal = 0; let totalItems = 0; let highestShipping = 0; if (cart.length === 0) { container.innerHTML = '<p style="text-align:center;color:#999;margin-top:50px;">Il carrello è vuoto</p>'; } else { cart.forEach(item => { const price = parseFloat((item.discountedPrice || item.price || '0').replace('€', '').replace(',', '.')); subtotal += price * item.quantity; totalItems += item.quantity; if (item.shippingCost > highestShipping) highestShipping = item.shippingCost; const imgUrl = item.thumbnailId ? `${driveImageUrl}${item.thumbnailId}` : 'https://via.placeholder.com/60x60?text=N/A'; const itemEl = document.createElement('div'); itemEl.className = 'cart-item'; itemEl.innerHTML = `<img src="${imgUrl}" alt="${item.name}"><div class="cart-item-details"><h4>${item.name}</h4><p>${item.quantity} x ${item.discountedPrice || item.price}</p></div><span class="cart-item-remove">×</span>`; itemEl.querySelector('.cart-item-remove').addEventListener('click', () => removeFromCart(item.name)); container.appendChild(itemEl); }); } shippingEl.textContent = cart.length > 0 ? `Spedizione: € ${highestShipping.toFixed(2)}` : 'Spedizione: non calcolata'; subtotalEl.textContent = `€ ${subtotal.toFixed(2)}`; let total = subtotal + (cart.length > 0 ? highestShipping : 0); if (appliedCoupon) { const productWithCoupon = allProducts.find(p => p.couponCode && p.couponCode.trim().toLowerCase() === appliedCoupon.code); if (productWithCoupon && cart.find(item => item.name === productWithCoupon.name)) { const couponDiscount = productWithCoupon.couponValue; total -= couponDiscount; document.getElementById('coupon-result').textContent = `Sconto "${appliedCoupon.code.toUpperCase()}" applicato: -€ ${couponDiscount.toFixed(2)}`; document.getElementById('coupon-result').className = 'coupon-result success'; } else { appliedCoupon = null; saveCart(); document.getElementById('coupon-result').textContent = 'Coupon non più valido.'; document.getElementById('coupon-result').className = 'coupon-result fail'; } } else { document.getElementById('coupon-result').textContent = ''; } totalEl.textContent = `€ ${total.toFixed(2)}`; badge.textContent = totalItems; badge.style.display = totalItems > 0 ? 'flex' : 'none'; document.getElementById('checkout-button').style.display = cart.length > 0 ? 'flex' : 'none'; }
      function applyCoupon() { const code = document.getElementById('coupon-input').value.trim().toLowerCase(); if (!code) return; const productWithCoupon = allProducts.find(p => p.couponCode && p.couponCode.trim().toLowerCase() === code); if (productWithCoupon && cart.find(item => item.name === productWithCoupon.name)) { appliedCoupon = { code: code }; updateCartUI(); } else { appliedCoupon = null; alert('Coupon non valido o prodotto non nel carrello.'); updateCartUI(); } saveCart(); }
      function saveCart() { try { localStorage.setItem('laMesolaShopCart', JSON.stringify({cart, coupon: appliedCoupon})); } catch(e) {} }
      function loadCart() { const saved = localStorage.getItem('laMesolaShopCart'); if (saved) { try { const data = JSON.parse(saved); cart = data.cart || []; appliedCoupon = data.coupon || null; } catch (e) { cart = []; appliedCoupon = null; } } updateCartUI(); }
    </script>
</body>
</html>
