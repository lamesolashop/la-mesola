<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop - La Mesola</title>
    <!-- Incolla qui tutto l'head con il CSS come nella risposta precedente -->
    <style> :root{--primary-color:#004d40;--text-color:#333;--card-bg:#ffffff}html,body{margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background-color:#f7f9f9;color:var(--text-color)}.site-wrapper{display:flex;position:relative;overflow-x:hidden}.content-wrapper{flex-grow:1;transition:margin-right .3s ease}.cart-sidebar{width:350px;position:fixed;top:0;right:-370px;height:100%;background-color:#fff;box-shadow:-4px 0 15px rgba(0,0,0,.1);z-index:1001;transition:right .3s ease;display:flex;flex-direction:column}.cart-sidebar.open{right:0}@media(min-width:901px){.content-wrapper.cart-open{margin-right:350px}}header{background-color:#fff;padding:10px 25px;box-shadow:0 2px 4px rgba(0,0,0,.05);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:999}header .logo a{font-weight:700;color:var(--primary-color);text-decoration:none;font-size:1.5rem}.header-actions{display:flex;align-items:center;gap:25px}.header-cart-icon{font-size:1.5rem;cursor:pointer;color:#555;position:relative}.cart-badge{position:absolute;top:-5px;right:-10px;background:#d32f2f;color:#fff;border-radius:50%;width:20px;height:20px;font-size:.8rem;display:flex;align-items:center;justify-content:center;font-weight:700}#hero-section{height:50vh;background-size:cover;background-position:center;position:relative;display:flex;align-items:center;justify-content:center;text-align:center;color:#fff;text-shadow:2px 2px 4px rgba(0,0,0,.7)}#hero-section::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,.5);z-index:1}.hero-content{position:relative;z-index:2;padding:20px}.page-container{max-width:1200px;margin:0 auto;padding:25px}#product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:30px}.product-card{background-color:var(--card-bg);border-radius:12px;overflow:hidden;cursor:pointer;transition:transform .3s,box-shadow .3s;display:flex;flex-direction:column;box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}.product-card:hover{transform:translateY(-8px) scale(1.02);box-shadow:0 20px 25px -5px rgba(0,0,0,.1)}.product-card img{width:100%;height:auto;aspect-ratio:2/3;object-fit:cover;display:block;background-color:#f0f0f0}.card-content{padding:20px;flex-grow:1;display:flex;flex-direction:column;justify-content:space-between}.product-title{font-size:1.2rem;margin:0 0 10px;color:var(--primary-color)}.card-info{font-size:.9rem;color:#666;margin-bottom:15px;border-left:3px solid #eee;padding-left:10px}.price-container{font-size:1.2rem;font-weight:700;margin-top:10px}footer{text-align:center;padding:40px 20px;background-color:var(--card-bg);margin-top:40px}.loading,.error{text-align:center;padding:50px;font-size:1.2rem;color:#666}.error{color:#d32f2f}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000}.modal-content{background:#fff;padding:30px;border-radius:10px;width:90%;max-width:900px;max-height:90vh;overflow-y:auto;position:relative}.modal-close{position:absolute;top:10px;right:20px;font-size:2.5rem;color:#aaa;cursor:pointer;line-height:1}.modal-body{display:grid;grid-template-columns:1fr 1fr;gap:30px}@media (max-width:768px){.modal-body{grid-template-columns:1fr}}.modal-gallery #modal-main-image{width:100%;height:auto;max-height:450px;object-fit:contain;border-radius:8px;border:1px solid #eee;margin-bottom:15px}.thumbnail-strip{display:flex;gap:10px;justify-content:center}.thumbnail-strip .thumbnail{width:70px;height:70px;object-fit:cover;border-radius:8px;cursor:pointer;border:2px solid #ddd;opacity:.7;transition:opacity .2s,border-color .2s}.thumbnail-strip .thumbnail:hover,.thumbnail-strip .thumbnail.active{opacity:1;border-color:var(--primary-color)}.action-button{display:flex;align-items:center;justify-content:center;width:100%;box-sizing:border-box;padding:12px;border-radius:5px;text-decoration:none;font-weight:700;margin-top:15px;cursor:pointer;border:none;font-size:1em;line-height:1.5}.quantity-selector{display:flex;align-items:center;gap:10px;margin-top:20px;margin-bottom:10px}.quantity-selector input{width:50px;text-align:center;font-size:1.1rem;border:1px solid #ccc;border-radius:5px}.cart-header{padding:20px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}.cart-items{flex-grow:1;overflow-y:auto;padding:10px 20px}.cart-item{display:flex;align-items:center;margin-bottom:15px}.cart-item img{width:60px;height:60px;object-fit:cover;border-radius:5px;margin-right:15px}.cart-item-details{flex-grow:1}.cart-item-details h4{margin:0 0 5px;font-size:1rem}.cart-item-details p{margin:0;color:#777}.cart-item-remove{font-size:1.2rem;color:#aaa;cursor:pointer}.cart-footer{padding:20px;border-top:1px solid #eee}.cart-total{display:flex;justify-content:space-between;font-weight:700;font-size:1.2rem;margin-bottom:15px}.coupon-section{display:flex;gap:10px;margin-bottom:15px}.coupon-section input{flex-grow:1;border:1px solid #ccc;padding:8px;border-radius:5px}.coupon-section button{padding:8px 12px;border:none;background:var(--primary-color);color:#fff;border-radius:5px;cursor:pointer}
    </style>
</head>
<body>
    <!-- HTML del body (invariato) -->
    <div class="site-wrapper">...</div>
    
    <script>
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwmLkRDFrdVqdnMF40C1qdafFVB10eGNKvsq0NZYDccRjOI7qvZjbkAz7CFEDgwXoJG/exec'; // <-- INCOLLA QUI IL TUO URL
      const driveImageUrl = "https://lh3.googleusercontent.com/d/";
      let allProducts = [], currentProduct = null, cart = [];
      let appliedCoupon = null;

      document.addEventListener("DOMContentLoaded", async () => {
        const grid = document.getElementById("product-grid");
        try {
            // Chiamata GET iniziale (funziona)
            const response = await fetch(SCRIPT_URL);
            if (!response.ok) throw new Error(`Errore di rete: ${response.statusText}`);
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            
            if (data.siteInfo && data.siteInfo.heroImageId) {
                document.getElementById("hero-section").style.backgroundImage = `url('${driveImageUrl}${data.siteInfo.heroImageId}')`;
            }
            allProducts = data.products || [];
            renderProducts(allProducts);
            loadCart();
            // Gestione ritorno da Stripe
            if (new URLSearchParams(window.location.search).get('payment') === 'success') {
                alert('Grazie! Il tuo acquisto è andato a buon fine.');
                cart = []; appliedCoupon = null; saveCart(); updateCartUI();
                window.history.replaceState({}, '', window.location.pathname);
            }
        } catch (e) {
            grid.innerHTML = `<div class="error"><h1>ERRORE</h1><p>${e.message}</p></div>`;
        }
      });
      
      // ... (Tutte le funzioni da renderProducts a loadCart rimangono uguali) ...
      // Per sicurezza, te le incollo.
      function renderProducts(products) { const grid = document.getElementById("product-grid"); grid.innerHTML = ''; if (!products.length) { grid.innerHTML = `<div class="error">Nessun prodotto trovato.</div>`; return; } products.forEach((p, i) => { const imgUrl = p.thumbnailId ? `${driveImageUrl}${p.thumbnailId}` : `https://via.placeholder.com/290x435?text=N/A`; const priceHtml = p.discountedPrice ? `<s>${p.price}</s> <span style="color:#d32f2f;">${p.discountedPrice}</span>` : (p.price || "N.D."); const card = document.createElement('div'); card.className = 'product-card'; card.onclick = () => openProductModal(i); card.innerHTML = `<img src="${imgUrl}" alt="${p.name}"><div class="card-content"><div><h2 class="product-title">${p.name}</h2><div class="card-info"><span>${p.cl} L</span> | <span>${p.sentore}</span><br><small><strong>Botaniche:</strong> ${p.botaniche}</small></div></div><div class="price-container">${priceHtml}</div></div>`; grid.appendChild(card); }); }
      function openModal(id) { document.getElementById(id).style.display = 'flex'; }
      function closeModal() { document.getElementById('product-modal').style.display = 'none'; }
      function openProductModal(index) { currentProduct = allProducts[index]; document.getElementById("modal-title").textContent = currentProduct.name; document.getElementById("modal-description").textContent = currentProduct.description; document.getElementById("modal-price").innerHTML = currentProduct.discountedPrice ? `<s>${currentProduct.price}</s> <span style="color:#d32f2f;">${currentProduct.discountedPrice}</span>` : (currentProduct.price || ''); document.getElementById("modal-quantity").value = 1; const extraInfoContainer = document.getElementById("modal-extra-info"); if(extraInfoContainer) { extraInfoContainer.innerHTML = ''; if (currentProduct.cl) extraInfoContainer.innerHTML += `<div class="info-item"><span class="info-item-label">FORMATO</span><span class="info-item-value">${currentProduct.cl} L</span></div>`; if (currentProduct.sentore) extraInfoContainer.innerHTML += `<div class="info-item"><span class="info-item-label">SENTORE</span><span class="info-item-value">${currentProduct.sentore}</span></div>`; if (currentProduct.botaniche) extraInfoContainer.innerHTML += `<div class="info-item" style="grid-column: 1 / -1;"><span class="info-item-label">BOTANICHE</span><span class="info-item-value">${currentProduct.botaniche}</span></div>`; } const mainImage = document.getElementById("modal-main-image"); const thumbStrip = document.getElementById("thumbnail-strip"); thumbStrip.innerHTML = ''; const imageUrls = [currentProduct.thumbnailId, currentProduct.image1Id, currentProduct.image2Id].filter(Boolean); if (imageUrls.length > 0) { mainImage.src = driveImageUrl + imageUrls[0]; imageUrls.forEach(id => { const thumb = document.createElement('img'); thumb.src = driveImageUrl + id; thumb.className = 'thumbnail'; thumb.onclick = e => { e.stopPropagation(); mainImage.src = driveImageUrl + id; }; thumbStrip.appendChild(thumb); }); } else { mainImage.src = 'https://via.placeholder.com/400x600?text=N/A'; } openModal('product-modal'); }
      function toggleCart() { document.getElementById('cart-sidebar').classList.toggle('open'); document.getElementById('content-wrapper').classList.toggle('cart-open'); }
      function handleAddToCart() { if (!currentProduct) return; const quantity = parseInt(document.getElementById('modal-quantity').value, 10); if (isNaN(quantity) || quantity < 1) return; const existingItem = cart.find(item => item.name === currentProduct.name); if (existingItem) { existingItem.quantity += quantity; } else { cart.push({ ...currentProduct, quantity: quantity }); } saveCart(); updateCartUI(); closeModal(); if(!document.getElementById('cart-sidebar').classList.contains('open')) toggleCart(); }
      function removeFromCart(productName) { cart = cart.filter(item => item.name !== productName); if (appliedCoupon && !cart.find(item => item.name === appliedCoupon.productName)) { appliedCoupon = null; } saveCart(); updateCartUI(); }
      function updateCartUI() { const container = document.getElementById('cart-items'); const subtotalEl = document.getElementById('cart-subtotal'); const totalEl = document.getElementById('cart-total'); const badge = document.getElementById('cart-badge'); const shippingEl = document.getElementById('shipping-cost-text'); container.innerHTML = ''; let subtotal = 0; let totalItems = 0; let highestShipping = 0; if (cart.length === 0) { container.innerHTML = '<p style="text-align:center;color:#999;margin-top:50px;">Il carrello è vuoto</p>'; } else { cart.forEach(item => { const price = parseFloat((item.discountedPrice || item.price || '0').replace('€', '').replace(',', '.')); subtotal += price * item.quantity; totalItems += item.quantity; if (item.shippingCost > highestShipping) highestShipping = item.shippingCost; const imgUrl = item.thumbnailId ? `${driveImageUrl}${item.thumbnailId}` : 'https://via.placeholder.com/60x60?text=N/A'; const itemEl = document.createElement('div'); itemEl.className = 'cart-item'; itemEl.innerHTML = `<img src="${imgUrl}" alt="${item.name}"><div class="cart-item-details"><h4>${item.name}</h4><p>${item.quantity} x ${item.discountedPrice || item.price}</p></div><span class="cart-item-remove">×</span>`; itemEl.querySelector('.cart-item-remove').addEventListener('click', () => removeFromCart(item.name)); container.appendChild(itemEl); }); } shippingEl.textContent = cart.length > 0 ? `Spedizione: € ${highestShipping.toFixed(2)}` : 'Spedizione: non calcolata'; subtotalEl.textContent = `€ ${subtotal.toFixed(2)}`; let total = subtotal + (cart.length > 0 ? highestShipping : 0); if (appliedCoupon) { const productWithCoupon = allProducts.find(p => p.couponCode && p.couponCode.trim().toLowerCase() === appliedCoupon.code); if (productWithCoupon && cart.find(item => item.name === productWithCoupon.name)) { const couponDiscount = productWithCoupon.couponValue; total -= couponDiscount; document.getElementById('coupon-result').textContent = `Sconto "${appliedCoupon.code.toUpperCase()}" applicato: -€ ${couponDiscount.toFixed(2)}`; } else { appliedCoupon = null; saveCart(); document.getElementById('coupon-result').textContent = 'Coupon non più valido.'; } } else { document.getElementById('coupon-result').textContent = ''; } totalEl.textContent = `€ ${total.toFixed(2)}`; badge.textContent = totalItems; badge.style.display = totalItems > 0 ? 'flex' : 'none'; document.getElementById('checkout-button').style.display = cart.length > 0 ? 'flex' : 'none'; }
      function applyCoupon() { const code = document.getElementById('coupon-input').value.trim().toLowerCase(); if (!code) return; const productWithCoupon = allProducts.find(p => p.couponCode && p.couponCode.trim().toLowerCase() === code); if (productWithCoupon && cart.find(item => item.name === productWithCoupon.name)) { appliedCoupon = { code: code }; alert('Coupon applicato!'); } else { appliedCoupon = null; alert('Coupon non valido o prodotto non nel carrello.'); } saveCart(); updateCartUI(); }
      function saveCart() { try { localStorage.setItem('laMesolaShopCart', JSON.stringify({cart, coupon: appliedCoupon})); } catch(e) {} }
      function loadCart() { const saved = localStorage.getItem('laMesolaShopCart'); if (saved) { try { const data = JSON.parse(saved); cart = data.cart || []; appliedCoupon = data.coupon || null; } catch (e) { cart = []; appliedCoupon = null; } } updateCartUI(); }
      
      // FUNZIONE CHECKOUT CORRETTA
      async function handleCheckout() {
        if(cart.length === 0) { alert("Il carrello è vuoto!"); return; }
        const btn = document.getElementById('checkout-button');
        btn.disabled = true; btn.textContent = 'Procedo...';
        const dataToSend = { cart: cart, coupon: appliedCoupon ? appliedCoupon.code : null };

        try {
            // Usiamo POST per inviare dati complessi
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                // L'header 'Content-Type': 'text/plain' è una tecnica per bypassare
                // il controllo "preflight" di CORS su alcune configurazioni.
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({
                    action: 'createCheckout',
                    payload: dataToSend
                })
            });

            if (!response.ok) throw new Error(`Errore di rete dal server: ${response.statusText}`);
            
            const res = await response.json();
            
            if (res.error) throw new Error(res.error);
            if (res.url) { 
                localStorage.removeItem('laMesolaShopCart'); 
                window.location.href = res.url; 
            } else {
                throw new Error("URL di checkout non ricevuto dal server.");
            }
        } catch(err) {
            alert('Errore grave durante il checkout: ' + err.message);
            btn.disabled = false; btn.textContent = 'Procedi al Checkout';
        }
      }
    </script>
</body>
</html>
